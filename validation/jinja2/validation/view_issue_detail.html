{#
      Copyright (C) 2021 Jolene Poulin <jcpoulin@ualberta.ca>

      This program is free software: you can redistribute it and/or modify
      it under the terms of the GNU Affero General Public License as
      published by the Free Software Foundation, either version 3 of the
      License, or (at your option) any later version.

      This program is distributed in the hope that it will be useful,
      but WITHOUT ANY WARRANTY; without even the implied warranty of
      MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
      GNU Affero General Public License for more details.

      You should have received a copy of the GNU Affero General Public License
      along with this program.  If not, see <http://www.gnu.org/licenses/>.
#}

{% extends 'validation/_base.html' %}
{% import 'validation/_macros.html' as macros %}
{% import 'validation/_issue_card.html' as issue_card %}

{% block content %}
    <h2>
        {% if issue.phrase %}
            You are editing the Phrase object for <a href="{{ url('validation:segment_detail',issue.language.code, issue.phrase.id) }}">this entry</a>
        {% else %}
            You are editing this specific Recording for <a href="{{ url('validation:segment_detail',issue.language.code, issue.recording.phrase.id) }}">this entry</a>
        {% endif %}
    </h2>
    <container style="display: flex">
        <section style="flex: 1">
        <h3>Current Information</h3>
            {% if issue.phrase %}
            Transcription: {{ issue.phrase.transcription }}<br>
            Translation: {{ issue.phrase.translation }}<br>
            {% endif %}
            {% if issue.recording %}
                {{ issue.recording }}<br>
                {{ macros.player(issue.recording) }}<br>
            {% endif %}
            {% if issue.source_language_suggestion %}
                    The {{ language }} word in this entry is wrong<br>
                {% endif %}
                {% if issue.target_language_suggestion %}
                    The English word in this entry is wrong<br>
                {% endif %}
                Comment: {{ issue.comment }}<br>
                {% if issue.source_language_suggestion %}
                    {{ language }} spelling suggestion: {{ issue.source_language_suggestion }}<br>
                {% endif %}
                {% if issue.target_language_suggestion %}
                    English spelling suggestion: {{ issue.target_language_suggestion }}<br>
                {% endif %}
            This issue was filed by {{ issue.created_by }} on
            {{ issue.created_on }}<br>
            <br>
            {% if issue.phrase %}
            The recordings for this phrase are:
            {% else %}
            Other recordings for the same phrase:
            {% endif %}
            <br>
            <ul class="list__recording">
                {% for recording in (issue.phrase.recordings if issue.phrase else issue.recording.phrase.recordings) %}
                {% if issue.phrase or recording != issue.recording %}        
                <li>
                    {{ macros.player(recording) }} by {{recording.speaker.code}}
                </li>
                {% endif %}
                {% endfor %}
            </ul>
            <div class="row">
                {% if other_issues %}
                <p> There are other issues for this specific entry as well:</p>
                {% endif %}
                {% for issue in other_issues %}
                    {{ issue_card.issue_card(issue, language) }}
                {% endfor %}
            </div>
        </section>

        <section style="flex: 1">
            <h3>Updates</h3>
            {% if form %}
                <form action="" method="POST">
                    <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
                    {{ form }}
                    <input data-cy="save-button" type="submit" class="button button--success" value="Resolve issue and return to list">
                </form>
            {% endif %}
        </section>
    </container>
    {% if autocomplete %}
    <script>
        $( () => {
            let completions = {{ autocomplete|safe }};
            $( "#autoCompleteTranscriptions").autocomplete({
                source: completions,
                minLength: 3
            });
            var first = true;
            $( "#autoCompleteTranscriptions").focus(() => {
                    $("#autoCompleteTranscriptions").autocomplete("search");
                })
        });
    </script>
    {% endif %}
{% endblock content %}
